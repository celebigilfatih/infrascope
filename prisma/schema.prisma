generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Represents the top-level organization entity
model Organization {
  id          String     @id @default(cuid())
  name        String     @unique
  code        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  buildings   Building[]
  vlans       Vlan[]
  subnets     Subnet[]
  vmwareClusters VMwareCluster[]
  vmwareDatastores VMwareDatastore[]

  @@map("organizations")
}

/// Physical building location
model Building {
  id                String               @id @default(cuid())
  name              String
  address           String
  city              String
  country           String
  postalCode        String?
  latitude          Float?
  longitude         Float?
  organizationId    String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  destConnections   BuildingConnection[] @relation("DestBuildingConnections")
  sourceConnections BuildingConnection[] @relation("SourceBuildingConnections")
  organization      Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  floors            Floor[]

  @@unique([organizationId, name])
  @@map("buildings")
}

/// Floor within a building
model Floor {
  id          String   @id @default(cuid())
  name        String
  floorNumber Int
  buildingId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms       Room[]

  @@unique([buildingId, floorNumber])
  @@map("floors")
}

/// Server room or equipment room on a floor
model Room {
  id          String   @id @default(cuid())
  name        String
  description String?
  floorId     String
  capacity    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  depth       Float?
  height      Float?
  width       Float?
  racks       Rack[]
  floor       Floor    @relation(fields: [floorId], references: [id], onDelete: Cascade)

  @@unique([floorId, name])
  @@map("rooms")
}

/// Rack cabinet for equipment
model Rack {
  id                String     @id @default(cuid())
  name              String
  type              RackType   @default(RACK_42U)
  maxUnits          Int        @default(42)
  roomId            String
  position          String?
  operationalStatus RackStatus @default(OPERATIONAL)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  coordX            Float?
  coordY            Float?
  coordZ            Float?
  rotation          Float      @default(0)
  devices           Device[]
  units             RackUnit[]
  room              Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, name])
  @@map("racks")
}

/// Individual U-height position in a rack
model RackUnit {
  id        String   @id @default(cuid())
  position  Int
  rackId    String
  deviceId  String?
  side      UnitSide @default(FRONT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  device    Device?  @relation(fields: [deviceId], references: [id])
  rack      Rack     @relation(fields: [rackId], references: [id], onDelete: Cascade)

  @@unique([rackId, position, side])
  @@map("rack_units")
}

/// Physical or virtual device
model Device {
  id                String             @id @default(cuid())
  name              String
  type              DeviceType
  vendor            String?
  model             String?
  serialNumber      String?
  assetTag          String?
  firmwareVersion   String?
  operatingSystem   String?
  criticality       DeviceCriticality  @default(MEDIUM)
  status            DeviceStatus       @default(UNKNOWN)
  rackId            String?
  rackUnitPosition  Int?
  parentDeviceId    String?
  supportDate       DateTime?
  healthScore       Int?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  metadata          Json?
  tags              String[]
  
  // Integration links
  zabbixHostId      String?
  vmwareMoref       String?  // VMware Managed Object Reference
  fortiDeviceId     String?
  
  // Relationships
  vmHostId          String?  // For VMs: which ESXi host
  
  dependencies      Dependency[]
  parentDevice      Device?            @relation("ChildDevices", fields: [parentDeviceId], references: [id])
  childDevices      Device[]           @relation("ChildDevices")
  rack              Rack?              @relation(fields: [rackId], references: [id])
  networkInterfaces NetworkInterface[]
  rackUnits         RackUnit[]
  services          Service[]
  switchPorts       SwitchPort[]
  
  // VMware relationships
  vmwareCluster     VMwareCluster?     @relation("ClusterHosts", fields: [vmwareClusterId], references: [id])
  vmwareClusterId   String?
  
  // Firewall relationships
  firewallPolicies  FirewallPolicy[]   @relation("FirewallDevice")
  firewallAddresses FirewallAddress[] @relation("FirewallDevice")
  
  // Topology relationships
  sourceRelationships Relationship[]   @relation("SourceDevice")
  targetRelationships Relationship[]   @relation("TargetDevice")

  @@index([rackId])
  @@index([parentDeviceId])
  @@index([zabbixHostId])
  @@index([vmwareMoref])
  @@index([vmwareClusterId])
  @@map("devices")
}

/// Network interface on a device
model NetworkInterface {
  id          String        @id @default(cuid())
  name        String
  type        InterfaceType @default(ETHERNET)
  ipv4        String?
  ipv6        String?
  macAddress  String?
  deviceId    String
  status      NetworkStatus @default(UP)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  vlanId      String?
  vlan        Vlan?         @relation(fields: [vlanId], references: [id])
  connections Connection[]
  device      Device        @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  switchPorts SwitchPort[]

  @@unique([deviceId, name])
  @@index([deviceId])
  @@map("network_interfaces")
}

/// Switch port management
model SwitchPort {
  id               String            @id @default(cuid())
  name             String
  portType         PortType          @default(ACCESS)
  vlanId           Int?
  nativeVlan       Int?
  allowedVlans     String?
  status           NetworkStatus     @default(DOWN)
  speed            String?
  duplex           Duplex?
  switchDeviceId   String
  connectedToId    String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  connections      Connection[]
  switchDevice     Device            @relation(fields: [switchDeviceId], references: [id], onDelete: Cascade, map: "switchPorts")
  networkInterface NetworkInterface? @relation(fields: [connectedToId], references: [id])

  @@unique([switchDeviceId, name])
  @@index([switchDeviceId])
  @@map("switch_ports")
}

/// Network connections between devices
model Connection {
  id                String            @id @default(cuid())
  name              String?
  type              ConnectionType    @default(ETHERNET)
  sourcePortId      String
  sourceInterfaceId String?
  destPortId        String?
  destInterfaceId   String?
  status            NetworkStatus     @default(DOWN)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  sourceInterface   NetworkInterface? @relation(fields: [sourceInterfaceId], references: [id], onDelete: Cascade)
  sourcePort        SwitchPort        @relation(fields: [sourcePortId], references: [id], onDelete: Cascade)

  @@index([sourcePortId])
  @@index([sourceInterfaceId])
  @@map("connections")
}

/// Physical connection between two buildings
model BuildingConnection {
  id               String                   @id @default(cuid())
  name             String?
  connectionType   BuildingConnectionType
  recordingMethod  RecordingMethod          @default(MANUAL)
  sourceBuildingId String
  destBuildingId   String
  status           BuildingConnectionStatus @default(ACTIVE)
  bandwidth        String?
  distance         Float?
  fiberType        String?
  cableSpecs       String?
  provider         String?
  circuitId        String?
  installDate      DateTime?
  notes            String?
  metadata         Json?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  destBuilding     Building                 @relation("DestBuildingConnections", fields: [destBuildingId], references: [id], onDelete: Cascade)
  sourceBuilding   Building                 @relation("SourceBuildingConnections", fields: [sourceBuildingId], references: [id], onDelete: Cascade)

  @@unique([sourceBuildingId, destBuildingId, connectionType])
  @@index([sourceBuildingId])
  @@index([destBuildingId])
  @@index([connectionType])
  @@index([status])
  @@map("building_connections")
}

/// Installed application on a device
model Application {
  id          String    @id @default(cuid())
  name        String
  vendor      String?
  version     String?
  installPath String?
  licenseKey  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  services    Service[]

  @@unique([name, version])
  @@map("applications")
}

/// Service running on a device
model Service {
  id            String            @id @default(cuid())
  name          String
  type          ServiceType
  displayName   String?
  description   String?
  status        ServiceStatus     @default(UNKNOWN)
  port          Int
  protocol      Protocol          @default(TCP)
  deviceId      String
  applicationId String?
  criticality   DeviceCriticality @default(MEDIUM)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  metadata      Json?
  dependencies  Dependency[]
  application   Application?      @relation(fields: [applicationId], references: [id])
  device        Device            @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([deviceId, port, protocol])
  @@index([deviceId])
  @@index([applicationId])
  @@map("services")
}

/// Dependency relationship between services
model Dependency {
  id              String            @id @default(cuid())
  sourceServiceId String
  targetDeviceId  String
  type            DependencyType    @default(DEPENDS_ON)
  criticality     DeviceCriticality @default(MEDIUM)
  description     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  sourceService   Service           @relation(fields: [sourceServiceId], references: [id], onDelete: Cascade)
  targetDevice    Device            @relation(fields: [targetDeviceId], references: [id], onDelete: Cascade)

  @@unique([sourceServiceId, targetDeviceId, type])
  @@index([sourceServiceId])
  @@index([targetDeviceId])
  @@map("dependencies")
}

/// Audit trail for changes
model AuditLog {
  id        String   @id @default(cuid())
  entity    String
  entityId  String
  action    String
  changes   Json?
  userId    String?
  timestamp DateTime @default(now())

  @@index([entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

/// Device health status snapshot
model DeviceHealthSnapshot {
  id             String       @id @default(cuid())
  deviceId       String
  status         DeviceStatus
  cpuUsage       Float?
  memoryUsage    Float?
  diskUsage      Float?
  networkLatency Float?
  timestamp      DateTime     @default(now())

  @@index([deviceId, timestamp])
  @@map("device_health_snapshots")
}

/// Rack cabinet types
enum RackType {
  RACK_42U
  RACK_45U
  CUSTOM
}

enum UnitSide {
  FRONT
  REAR
}

enum RackStatus {
  OPERATIONAL
  MAINTENANCE
  DECOMMISSIONED
}

enum DeviceType {
  PHYSICAL_SERVER
  VIRTUAL_HOST
  VIRTUAL_MACHINE
  FIREWALL
  SWITCH
  ROUTER
  COMPUTER
  LAPTOP
  STORAGE
  PDU
  PATCH_PANEL
  OTHER
  PRINTER
  CAMERA
  VLAN
  VMWARE_CLUSTER
  VMWARE_DATASTORE
}

enum DeviceCriticality {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum DeviceStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  DECOMMISSIONED
  UNKNOWN
}

enum InterfaceType {
  ETHERNET
  FIBER
  WIRELESS
  SERIAL
  MANAGEMENT
  OTHER
}

enum NetworkStatus {
  UP
  DOWN
  DORMANT
  UNKNOWN
}

enum PortType {
  ACCESS
  TRUNK
  HYBRID
  MANAGEMENT
  UPLINK
}

enum Duplex {
  FULL
  HALF
  AUTO
}

enum ConnectionType {
  ETHERNET
  FIBER
  SERIAL
  MANAGEMENT
  WAN
}

/// Types of physical connections between buildings
enum BuildingConnectionType {
  FIBER_SINGLE_MODE
  FIBER_MULTI_MODE
  CAT5E
  CAT6
  CAT6A
  CAT7
  CAT8
  WIRELESS
  MICROWAVE
  LEASED_LINE
  MPLS
  VPN
  OTHER
}

/// Recording method for the connection
enum RecordingMethod {
  AUTO
  MANUAL
}

/// Status of the building connection
enum BuildingConnectionStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  PLANNED
  DECOMMISSIONED
}

enum ServiceType {
  WEB_SERVER
  DATABASE
  DNS
  DHCP
  LDAP
  MONITORING
  BACKUP
  FILE_SERVER
  MAIL_SERVER
  PROXY
  VPN
  LOAD_BALANCER
  STORAGE
  CONTAINER_ORCHESTRATION
  OTHER
}

enum ServiceStatus {
  RUNNING
  STOPPED
  DEGRADED
  FAILED
  UNKNOWN
}

enum Protocol {
  TCP
  UDP
  BOTH
}

enum DependencyType {
  DEPENDS_ON
  REQUIRES
  PROVIDES
  SUPPORTS
  COMMUNICATES_WITH
  DEPLOYED_ON
  HOSTED_ON
  CONNECTED_TO
}

// ============================================================================
// ENTERPRISE EXTENSIONS - VLANs, Subnets, Firewall, VMware, Relationships
// ============================================================================

/// VLAN configuration
model Vlan {
  id              String   @id @default(cuid())
  organizationId  String
  vlanId          Int
  name            String
  subnet          String?  // CIDR notation
  gateway         String?
  vrf             String?
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  interfaces      NetworkInterface[]
  subnets         Subnet[]

  @@unique([organizationId, vlanId])
  @@map("vlans")
}

/// IP Subnet allocation
model Subnet {
  id              String     @id @default(cuid())
  organizationId  String
  cidr            String     // CIDR notation
  name            String?
  type            SubnetType @default(MANAGEMENT)
  description     String?
  vlanId          String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  vlan            Vlan?      @relation(fields: [vlanId], references: [id])
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, cidr])
  @@map("subnets")
}

/// Firewall Policy
model FirewallPolicy {
  id              String   @id @default(cuid())
  deviceId        String   // FortiGate device
  policyId        Int
  name            String?
  action          String   // accept, deny
  srcInterface    String?
  dstInterface    String?
  srcAddresses    Json?    // Array of address names/IPs
  dstAddresses    Json?
  services        Json?    // Array of service names/ports
  schedule        String?
  hitCount        BigInt   @default(0)
  lastHit         DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  device          Device   @relation("FirewallDevice", fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([deviceId, policyId])
  @@index([deviceId])
  @@map("firewall_policies")
}

/// Firewall Address Object
model FirewallAddress {
  id              String   @id @default(cuid())
  deviceId        String   // FortiGate device
  name            String
  type            String   // ipmask, fqdn, geoip, group
  value           String   // IP, subnet, FQDN
  associatedInterface String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  device          Device   @relation("FirewallDevice", fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@map("firewall_addresses")
}

/// VMware Cluster
model VMwareCluster {
  id              String   @id @default(cuid())
  organizationId  String
  vcenterId       String   // External vCenter identifier
  datacenterName  String
  name            String
  cpuTotal        BigInt?
  cpuUsed         BigInt?
  memoryTotal     BigInt?
  memoryUsed      BigInt?
  hostCount       Int      @default(0)
  vmCount         Int      @default(0)
  status          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  hosts           Device[]  @relation("ClusterHosts")
  datastores      VMwareDatastore[]

  @@index([organizationId])
  @@map("vmware_clusters")
}

/// VMware Datastore
model VMwareDatastore {
  id              String   @id @default(cuid())
  organizationId  String
  vcenterId       String
  name            String
  type            String?  // VMFS, NFS, VVTD
  capacity        BigInt?
  freeSpace       BigInt?
  datacenter      String?
  clusterId       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  cluster         VMwareCluster? @relation(fields: [clusterId], references: [id])

  @@index([organizationId])
  @@index([clusterId])
  @@map("vmware_datastores")
}

/// VM Snapshot
model VmSnapshot {
  id          String   @id @default(cuid())
  vmId        String   // Reference to Device (VM)
  snapshotId  String   // VMware snapshot ID
  name        String?
  description String?
  createdAt   DateTime @default(now())
  size        BigInt?
  isCurrent   Boolean  @default(false)

  @@index([vmId])
  @@map("vm_snapshots")
}

/// Topology Relationship (edges between devices)
model Relationship {
  id                  String            @id @default(cuid())
  sourceDeviceId      String
  targetDeviceId      String
  relationshipType    RelationshipType
  properties          Json?             // Additional data (VLAN, policy ID, etc.)
  source              String            // 'zabbix', 'vmware', 'snmp', 'manual'
  confidence          Float             @default(1.0)  // 0.00-1.00
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  sourceDevice        Device            @relation("SourceDevice", fields: [sourceDeviceId], references: [id], onDelete: Cascade)
  targetDevice        Device            @relation("TargetDevice", fields: [targetDeviceId], references: [id], onDelete: Cascade)

  @@index([sourceDeviceId])
  @@index([targetDeviceId])
  @@index([relationshipType])
  @@map("relationships")
}

/// Integration Configuration
model IntegrationConfig {
  id              String             @id @default(cuid())
  type            IntegrationType
  name            String
  description     String?
  config          Json               // Encrypted credentials
  enabled         Boolean            @default(true)
  lastSyncAt      DateTime?
  lastSyncStatus  String?
  syncInterval    Int                @default(5)  // minutes
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  syncLogs        IntegrationSyncLog[]

  @@unique([type, name])
  @@map("integration_configs")
}

/// Integration Sync Log
model IntegrationSyncLog {
  id              String            @id @default(cuid())
  configId        String
  status          String            // success, partial, failed
  message         String?
  itemsProcessed  Int               @default(0)
  itemsCreated    Int               @default(0)
  itemsUpdated    Int               @default(0)
  itemsDeleted    Int               @default(0)
  errorDetails    Json?
  startedAt       DateTime          @default(now())
  completedAt     DateTime?
  config          IntegrationConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@index([startedAt])
  @@map("integration_sync_logs")
}

/// Zabbix Trigger / Alert
model ZabbixTrigger {
  id              String   @id @default(cuid())
  triggerId       String   // Zabbix internal ID
  hostId          String
  description     String
  expression      String?
  priority        Int      @default(0)
  status          String   // OK, PROBLEM
  value           Int      @default(0)
  lastChange      DateTime?
  comments        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([triggerId])
  @@index([hostId])
  @@index([status])
  @@map("zabbix_triggers")
}

/// Alert Event
model AlertEvent {
  id              String      @id @default(cuid())
  source          String      // zabbix, vmware, fortigate, manual
  sourceId        String
  type            String      // trigger, threshold, discovery
  severity        AlertSeverity
  title           String
  message         String?
  deviceId        String?
  acknowledged    Boolean     @default(false)
  acknowledgedBy  String?
  acknowledgedAt  DateTime?
  resolvedAt      DateTime?
  metadata        Json?
  createdAt       DateTime    @default(now())

  @@index([source])
  @@index([severity])
  @@index([deviceId])
  @@index([createdAt])
  @@map("alert_events")
}

/// Scheduled Task / Automation Job
model ScheduledTask {
  id              String           @id @default(cuid())
  name            String
  description     String?
  type            TaskType
  cronExpression  String
  config          Json             // Task-specific configuration
  enabled         Boolean          @default(true)
  lastRunAt       DateTime?
  lastRunStatus   String?
  nextRunAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  taskLogs        TaskLog[]

  @@map("scheduled_tasks")
}

/// Task Execution Log
model TaskLog {
  id              String        @id @default(cuid())
  taskId          String
  status          String        // running, success, failed
  message         String?
  output          Json?
  startedAt       DateTime      @default(now())
  completedAt     DateTime?
  task            ScheduledTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([startedAt])
  @@map("task_logs")
}

// ============================================================================
// ENUMS - Enterprise Extensions
// ============================================================================

enum SubnetType {
  MANAGEMENT
  PRODUCTION
  DEVELOPMENT
  DMZ
  GUEST
  RESERVED
}

enum RelationshipType {
  CONTAINS           // Parent-child (rack contains device)
  CONNECTS_TO        // Physical connection
  VIRTUAL_RUNS_ON    // VM on host
  CLUSTER_CONTAINS   // Cluster has host
  VLAN_MEMBER        // Interface in VLAN
  FIREWALL_POLICY    // Policy allows traffic
  SERVICE_DEPENDENCY // App depends on service
  HA_PAIR            // HA redundant pair
  UPLINK             // Access to core
  SPANNING_TREE      // STP blocking
}

enum IntegrationType {
  ZABBIX
  VMWARE_VCENTER
  FORTIGATE
  FORTIANALYZER
  SNMP
  AWS
  AZURE
  API
}

enum AlertSeverity {
  INFO
  WARNING
  AVERAGE
  HIGH
  DISASTER
}

enum TaskType {
  DISCOVERY
  SYNC
  BACKUP
  REPORT
  CLEANUP
  CUSTOM
}
