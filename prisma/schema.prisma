generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Represents the top-level organization entity
model Organization {
  id          String     @id @default(cuid())
  name        String     @unique
  code        String     @unique
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  buildings   Building[]

  @@map("organizations")
}

/// Physical building location
model Building {
  id                String               @id @default(cuid())
  name              String
  address           String
  city              String
  country           String
  postalCode        String?
  latitude          Float?
  longitude         Float?
  organizationId    String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  destConnections   BuildingConnection[] @relation("DestBuildingConnections")
  sourceConnections BuildingConnection[] @relation("SourceBuildingConnections")
  organization      Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  floors            Floor[]

  @@unique([organizationId, name])
  @@map("buildings")
}

/// Floor within a building
model Floor {
  id          String   @id @default(cuid())
  name        String
  floorNumber Int
  buildingId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  building    Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms       Room[]

  @@unique([buildingId, floorNumber])
  @@map("floors")
}

/// Server room or equipment room on a floor
model Room {
  id          String   @id @default(cuid())
  name        String
  description String?
  floorId     String
  capacity    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  depth       Float?
  height      Float?
  width       Float?
  racks       Rack[]
  floor       Floor    @relation(fields: [floorId], references: [id], onDelete: Cascade)

  @@unique([floorId, name])
  @@map("rooms")
}

/// Rack cabinet for equipment
model Rack {
  id                String     @id @default(cuid())
  name              String
  type              RackType   @default(RACK_42U)
  maxUnits          Int        @default(42)
  roomId            String
  position          String?
  operationalStatus RackStatus @default(OPERATIONAL)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  coordX            Float?
  coordY            Float?
  coordZ            Float?
  rotation          Float      @default(0)
  devices           Device[]
  units             RackUnit[]
  room              Room       @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([roomId, name])
  @@map("racks")
}

/// Individual U-height position in a rack
model RackUnit {
  id        String   @id @default(cuid())
  position  Int
  rackId    String
  deviceId  String?
  side      UnitSide @default(FRONT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  device    Device?  @relation(fields: [deviceId], references: [id])
  rack      Rack     @relation(fields: [rackId], references: [id], onDelete: Cascade)

  @@unique([rackId, position, side])
  @@map("rack_units")
}

/// Physical or virtual device
model Device {
  id                String             @id @default(cuid())
  name              String
  type              DeviceType
  vendor            String?
  model             String?
  serialNumber      String?
  assetTag          String?
  firmwareVersion   String?
  operatingSystem   String?
  criticality       DeviceCriticality  @default(MEDIUM)
  status            DeviceStatus       @default(UNKNOWN)
  rackId            String?
  rackUnitPosition  Int?
  parentDeviceId    String?
  supportDate       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  metadata          Json?
  dependencies      Dependency[]
  parentDevice      Device?            @relation("ChildDevices", fields: [parentDeviceId], references: [id])
  childDevices      Device[]           @relation("ChildDevices")
  rack              Rack?              @relation(fields: [rackId], references: [id])
  networkInterfaces NetworkInterface[]
  rackUnits         RackUnit[]
  services          Service[]
  switchPorts       SwitchPort[]

  @@index([rackId])
  @@index([parentDeviceId])
  @@map("devices")
}

/// Network interface on a device
model NetworkInterface {
  id          String        @id @default(cuid())
  name        String
  type        InterfaceType @default(ETHERNET)
  ipv4        String?
  ipv6        String?
  macAddress  String?
  deviceId    String
  status      NetworkStatus @default(UP)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  connections Connection[]
  device      Device        @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  switchPorts SwitchPort[]

  @@unique([deviceId, name])
  @@index([deviceId])
  @@map("network_interfaces")
}

/// Switch port management
model SwitchPort {
  id               String            @id @default(cuid())
  name             String
  portType         PortType          @default(ACCESS)
  vlanId           Int?
  nativeVlan       Int?
  allowedVlans     String?
  status           NetworkStatus     @default(DOWN)
  speed            String?
  duplex           Duplex?
  switchDeviceId   String
  connectedToId    String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  connections      Connection[]
  switchDevice     Device            @relation(fields: [switchDeviceId], references: [id], onDelete: Cascade, map: "switchPorts")
  networkInterface NetworkInterface? @relation(fields: [connectedToId], references: [id])

  @@unique([switchDeviceId, name])
  @@index([switchDeviceId])
  @@map("switch_ports")
}

/// Network connections between devices
model Connection {
  id                String            @id @default(cuid())
  name              String?
  type              ConnectionType    @default(ETHERNET)
  sourcePortId      String
  sourceInterfaceId String?
  destPortId        String?
  destInterfaceId   String?
  status            NetworkStatus     @default(DOWN)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  sourceInterface   NetworkInterface? @relation(fields: [sourceInterfaceId], references: [id], onDelete: Cascade)
  sourcePort        SwitchPort        @relation(fields: [sourcePortId], references: [id], onDelete: Cascade)

  @@index([sourcePortId])
  @@index([sourceInterfaceId])
  @@map("connections")
}

/// Physical connection between two buildings
model BuildingConnection {
  id               String                   @id @default(cuid())
  name             String?
  connectionType   BuildingConnectionType
  recordingMethod  RecordingMethod          @default(MANUAL)
  sourceBuildingId String
  destBuildingId   String
  status           BuildingConnectionStatus @default(ACTIVE)
  bandwidth        String?
  distance         Float?
  fiberType        String?
  cableSpecs       String?
  provider         String?
  circuitId        String?
  installDate      DateTime?
  notes            String?
  metadata         Json?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @updatedAt
  destBuilding     Building                 @relation("DestBuildingConnections", fields: [destBuildingId], references: [id], onDelete: Cascade)
  sourceBuilding   Building                 @relation("SourceBuildingConnections", fields: [sourceBuildingId], references: [id], onDelete: Cascade)

  @@unique([sourceBuildingId, destBuildingId, connectionType])
  @@index([sourceBuildingId])
  @@index([destBuildingId])
  @@index([connectionType])
  @@index([status])
  @@map("building_connections")
}

/// Installed application on a device
model Application {
  id          String    @id @default(cuid())
  name        String
  vendor      String?
  version     String?
  installPath String?
  licenseKey  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  services    Service[]

  @@unique([name, version])
  @@map("applications")
}

/// Service running on a device
model Service {
  id            String            @id @default(cuid())
  name          String
  type          ServiceType
  displayName   String?
  description   String?
  status        ServiceStatus     @default(UNKNOWN)
  port          Int
  protocol      Protocol          @default(TCP)
  deviceId      String
  applicationId String?
  criticality   DeviceCriticality @default(MEDIUM)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  metadata      Json?
  dependencies  Dependency[]
  application   Application?      @relation(fields: [applicationId], references: [id])
  device        Device            @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@unique([deviceId, port, protocol])
  @@index([deviceId])
  @@index([applicationId])
  @@map("services")
}

/// Dependency relationship between services
model Dependency {
  id              String            @id @default(cuid())
  sourceServiceId String
  targetDeviceId  String
  type            DependencyType    @default(DEPENDS_ON)
  criticality     DeviceCriticality @default(MEDIUM)
  description     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  sourceService   Service           @relation(fields: [sourceServiceId], references: [id], onDelete: Cascade)
  targetDevice    Device            @relation(fields: [targetDeviceId], references: [id], onDelete: Cascade)

  @@unique([sourceServiceId, targetDeviceId, type])
  @@index([sourceServiceId])
  @@index([targetDeviceId])
  @@map("dependencies")
}

/// Audit trail for changes
model AuditLog {
  id        String   @id @default(cuid())
  entity    String
  entityId  String
  action    String
  changes   Json?
  userId    String?
  timestamp DateTime @default(now())

  @@index([entityId])
  @@index([timestamp])
  @@map("audit_logs")
}

/// Device health status snapshot
model DeviceHealthSnapshot {
  id             String       @id @default(cuid())
  deviceId       String
  status         DeviceStatus
  cpuUsage       Float?
  memoryUsage    Float?
  diskUsage      Float?
  networkLatency Float?
  timestamp      DateTime     @default(now())

  @@index([deviceId, timestamp])
  @@map("device_health_snapshots")
}

/// Rack cabinet types
enum RackType {
  RACK_42U
  RACK_45U
  CUSTOM
}

enum UnitSide {
  FRONT
  REAR
}

enum RackStatus {
  OPERATIONAL
  MAINTENANCE
  DECOMMISSIONED
}

enum DeviceType {
  PHYSICAL_SERVER
  VIRTUAL_HOST
  VIRTUAL_MACHINE
  FIREWALL
  SWITCH
  ROUTER
  COMPUTER
  LAPTOP
  STORAGE
  PDU
  PATCH_PANEL
  OTHER
  PRINTER
  CAMERA
}

enum DeviceCriticality {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFORMATIONAL
}

enum DeviceStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  DECOMMISSIONED
  UNKNOWN
}

enum InterfaceType {
  ETHERNET
  FIBER
  WIRELESS
  SERIAL
  MANAGEMENT
  OTHER
}

enum NetworkStatus {
  UP
  DOWN
  DORMANT
  UNKNOWN
}

enum PortType {
  ACCESS
  TRUNK
  HYBRID
  MANAGEMENT
  UPLINK
}

enum Duplex {
  FULL
  HALF
  AUTO
}

enum ConnectionType {
  ETHERNET
  FIBER
  SERIAL
  MANAGEMENT
  WAN
}

/// Types of physical connections between buildings
enum BuildingConnectionType {
  FIBER_SINGLE_MODE
  FIBER_MULTI_MODE
  CAT5E
  CAT6
  CAT6A
  CAT7
  CAT8
  WIRELESS
  MICROWAVE
  LEASED_LINE
  MPLS
  VPN
  OTHER
}

/// Recording method for the connection
enum RecordingMethod {
  AUTO
  MANUAL
}

/// Status of the building connection
enum BuildingConnectionStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  PLANNED
  DECOMMISSIONED
}

enum ServiceType {
  WEB_SERVER
  DATABASE
  DNS
  DHCP
  LDAP
  MONITORING
  BACKUP
  FILE_SERVER
  MAIL_SERVER
  PROXY
  VPN
  LOAD_BALANCER
  STORAGE
  CONTAINER_ORCHESTRATION
  OTHER
}

enum ServiceStatus {
  RUNNING
  STOPPED
  DEGRADED
  FAILED
  UNKNOWN
}

enum Protocol {
  TCP
  UDP
  BOTH
}

enum DependencyType {
  DEPENDS_ON
  REQUIRES
  PROVIDES
  SUPPORTS
  COMMUNICATES_WITH
  DEPLOYED_ON
  HOSTED_ON
  CONNECTED_TO
}
